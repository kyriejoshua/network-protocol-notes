# UDP

## 摘要

> 本文介绍了udp协议的特点和使用场景，对比了 TCP。TCP 连接的本质并不是物理上建立的连接，而是**逻辑上的连接**，通过在客户端和服务器端维护一个数据结构（**一种状态机**），记录连接状态和报文发送的情况从而采取相应的策略，比如按照顺序到达，维护报文的接受顺序，网络拥塞的数据结构标识，不可重复。而 UDP 的无连接概念就是在客户端和服务器没有维护这种数据结构，报文也很简单——源端口，目的端口，传输过程就是一个普通的数据包。数据包怎么传输 UDP 就怎么传输，所以连接比较依靠内存和 cpu。

## TCP 与 UDP 区别

所谓的建立连接，是为了在客户端和服务端维护连接，而建立一定的数据结构来维护双方交互的状态，用这样的数据结构来保证所谓的面向连接的特性。**维护一套数据结构协议来保证客户端和服务端的连接。**

| TCP          | UDP                                              |
| ------------ | ------------------------------------------------ |
| 面向连接     | 面向无连接                                       |
| 面向字节流   | 继承 IP 包的特性，基于数据报的                   |
| 提供可靠交付 | 继承 IP 包的特性，不保证不丢失，不保证按顺序到达 |
| 支持拥塞控制 | 不支持拥塞控制                                   |
| 有状态服务   | 无状态服务                                       |

我们可以这样比喻，如果 MAC 层定义了本地局域网的传输行为，IP 层定义了整个网络端到端的传输行为，这两层基本定义了这样的基因：网络传输是以包为单位的，二层叫帧(`frame`)，网络层叫包(`packet`)，传输层叫段(`segment`)。我们笼统地称为包。包单独传输，自行选路，在不同的设备封装解封装，不保证到达。

## UDP 格式

### UDP 包头

包头只有下面这两块东西，只有 8 个字节。
* IP 头里有 8 位协议，区分是 UDP 还是 TCP.
* 端口号：用于区分应用程序。
	* 源端口号
	* 目标端口号

![](https://static001.geekbang.org/resource/image/2c/84/2c9a109f3be308dea901004a5a3b4c84.jpg?wh=2183*1103)

### UDP 特性

* 沟通简单，成本低，没有复杂的数据和逻辑控制。
* 可以任意传输数据，只要匹配上端口号。
* 能够发送大量的数据包。
* 低延迟。
* 每个包只管发，不像 TCP 会做网络拥塞控制。

### UDP 应用三大场景

1. 需要资源少，在网络情况比较好的内网，或者对于**丢包不敏感**的应用。
	* 先前提到的 DHCP(动态主机配置协议) 是基于 UDP 的；
	* PXE 安装操作系统的时候，操作系统镜像的下载使用 TFTP 协议也是基于 UDP 的.
2. 不需要一对一沟通建立连接，而是可以**广播**的应用。
	* UDP 的不面向连接的功能，可以使得它承载广播或者多播的协议。DHCP 就是一种广播的形式，就是基于 UDP 协议的。
3. 需要**处理速度快，时延低，可以容忍少数丢包**，但是要求即便网络拥塞，也不受影响的场景。

#### 基于 UDP 使用的具体例子

**网页或者 APP 的访问： 低时延**
* 使用基于 TCP 的 HTTP 协议，在移动端会受限，TCP 建立连接的时延比较长，而移动端对时间又比较敏感；
* 谷歌推出了 GUIC 协议，是基于 UDP 改进的，目的是降低网络通信的延迟。QUIC 在应用层上会自己实现快速建立连接，减少重传时延，自适应拥塞控制，这些具体会在后面的应用层讲述。

**流媒体协议：允许丢帧**
* 目前很多是基于 TCP 实现的 RTMP 协议。
* 但很多直播应用基于 UDP 实现了自己的视频传输协议。

**实时游戏：实时性要求高**
游戏通常会采用自定义的可靠 UDP 协议，自定义重传策略，能够把丢包产生的延迟降到最低，尽量减少网络问题对游戏性造成的影响。
* TCP 连接需要维护数据结构，所以每台服务器能够支持的数量有限。
* UDP 是无连接的，是海量客户端连接的首选策略。

**物联网：内存有限，实时性高**
* 物联网领域终端资源少，很可能只是个内存非常小的嵌入式系统，没有多余内存来维护 TCP.
* 谷歌推出的物联网通信协议 Thread 就是基于 UDP 协议的。

**移动通信领域**
* 4G 网络的协议 GTP-U 是基于 UDP. 移动网络协议本身复杂，基于 TCP 会有很多冗余机制。

## 延伸

都说 TCP 是面向连接的，在计算机看来，怎么样才算一个连接呢？
* TCP/UDP 建立连接的本质就是在客户端和服务端各自维护一定的数据结构（状态机），来记录和维护这个“连接”的状态 。在IP层，网络情况该不稳定还是不稳定，数据传输走的是什么路径上层是控制不了的，TCP能做的只能是做更多判断，更多重试，更多拥塞控制之类的东西